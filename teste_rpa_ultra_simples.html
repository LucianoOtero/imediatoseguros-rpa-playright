<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste RPA Ultra Simples</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; }
        .progress-bar { width: 100%; height: 30px; background: #e0e0e0; border-radius: 15px; overflow: hidden; }
        .progress-fill { height: 100%; background: #4CAF50; transition: width 0.5s ease; width: 0%; }
        .status { margin: 15px 0; font-size: 18px; text-align: center; }
        button { padding: 15px 30px; background: #4CAF50; color: white; border: none; border-radius: 5px; cursor: pointer; margin: 10px; }
        button:disabled { background: #ccc; }
        .log { background: #f8f9fa; padding: 15px; margin-top: 20px; max-height: 400px; overflow-y: auto; }
        .log-entry { margin: 5px 0; padding: 5px; background: white; border-radius: 3px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>🚀 Teste RPA Ultra Simples</h1>
        <p>Versão que deve funcionar sem problemas</p>
        
        <div class="progress-bar">
            <div class="progress-fill" id="progress-bar"></div>
        </div>
        <div class="status" id="status">Aguardando início...</div>
        
        <div style="text-align: center;">
            <button onclick="iniciarRPA()" id="btn-iniciar">🚀 Iniciar RPA</button>
            <button onclick="pararTeste()" id="btn-parar" disabled>🛑 Parar</button>
        </div>
        
        <div class="log" id="log">
            <h3>Log de Eventos</h3>
            <div id="log-entries"></div>
        </div>
    </div>
    
    <script>
        let eventSource = null;
        let sessionId = 'simple_' + Math.random().toString(36).substr(2, 9);
        
        function log(message) {
            const logContainer = document.getElementById('log-entries');
            const timestamp = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.innerHTML = '<strong>[' + timestamp + ']</strong> ' + message;
            logContainer.appendChild(entry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }
        
        function iniciarRPA() {
            if (eventSource) {
                log('⚠️ RPA já está em execução');
                return;
            }
            
            log('🚀 Iniciando RPA...');
            log('🌐 Chrome será aberto automaticamente');
            
            document.getElementById('btn-iniciar').disabled = true;
            document.getElementById('btn-parar').disabled = false;
            document.getElementById('status').textContent = 'Conectando...';
            
            const url = 'progress_sse_ultra_simples.php?session_id=' + sessionId;
            log('🔗 Conectando em: ' + url);
            
            try {
                eventSource = new EventSource(url);
                
                eventSource.onopen = function() {
                    log('✅ Conexão estabelecida');
                };
                
                eventSource.onmessage = function(event) {
                    log('📨 Mensagem recebida: ' + event.data);
                    try {
                        const data = JSON.parse(event.data);
                        processarMensagem(data);
                    } catch (error) {
                        log('❌ Erro ao processar: ' + error.message);
                    }
                };
                
                eventSource.onerror = function(error) {
                    log('❌ Erro na conexão');
                    console.error('SSE Error:', error);
                    pararTeste();
                };
                
            } catch (error) {
                log('❌ Erro ao criar EventSource: ' + error.message);
                console.error('EventSource Error:', error);
            }
        }
        
        function processarMensagem(data) {
            log('📨 Status: ' + (data.status || 'progresso') + ' - ' + (data.message || 'atualizando'));
            
            if (data.status === 'starting') {
                document.getElementById('status').textContent = '🚀 Iniciando RPA...';
                atualizarProgresso(0);
            } else if (data.status === 'started') {
                document.getElementById('status').textContent = '🌐 Chrome aberto - RPA executando...';
                log('🎭 Playwright abriu Chrome!');
            } else if (data.status === 'completed') {
                document.getElementById('status').textContent = '✅ RPA concluído!';
                atualizarProgresso(100);
                log('🎉 RPA executado com sucesso!');
                pararTeste();
            } else if (data.status === 'timeout') {
                document.getElementById('status').textContent = '⏰ Timeout';
                log('⏰ Timeout atingido');
                pararTeste();
            } else if (data.status === 'error') {
                document.getElementById('status').textContent = '❌ Erro';
                log('❌ Erro: ' + data.message);
                pararTeste();
            } else if (data.etapa_atual !== undefined) {
                const percentual = Math.round(data.percentual || 0);
                const etapa = data.etapa_atual || 0;
                const status = data.status || 'Processando...';
                
                atualizarProgresso(percentual);
                document.getElementById('status').textContent = status + ' (' + etapa + '/15)';
                log('📊 Etapa ' + etapa + ': ' + status + ' (' + percentual + '%)');
            }
        }
        
        function atualizarProgresso(percentual) {
            document.getElementById('progress-bar').style.width = percentual + '%';
        }
        
        function pararTeste() {
            if (eventSource) {
                eventSource.close();
                eventSource = null;
                log('🛑 Monitoramento parado');
            }
            
            document.getElementById('btn-iniciar').disabled = false;
            document.getElementById('btn-parar').disabled = true;
        }
        
        window.onload = function() {
            log('📱 Página carregada - Pronto para executar RPA');
            log('💡 Clique em "Iniciar RPA" para executar o Playwright');
        };
    </script>
</body>
</html>
